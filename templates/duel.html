<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Trainer - Duel Mode</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        @keyframes gradient-shift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes fadeInUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes glow {
            0%, 100% { box-shadow: 0 0 20px rgba(25, 118, 210, 0.3); }
            50% { box-shadow: 0 0 30px rgba(25, 118, 210, 0.6); }
        }
        
        @keyframes battle-shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-2px); }
            75% { transform: translateX(2px); }
        }
        
        @keyframes countdown-pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        html, body {
            height: 100vh;
            margin: 0;
            padding: 0;
            background: white;
            color: #222;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        body {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .top-bar {
            width: 100vw;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: absolute;
            top: 0;
            left: 0;
            padding: 32px 48px 0 48px;
            box-sizing: border-box;
            font-size: 1.5rem;
            font-weight: 300;
            color: #1976d2;
            letter-spacing: 1px;
            z-index: 100;
        }
        
        .main-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            max-width: 800px;
            padding: 20px;
            box-sizing: border-box;
        }
        
        .duel-setup {
            background: transparent;
            padding: 30px;
            text-align: center;
            max-width: 500px;
            width: 100%;
            animation: fadeInUp 0.8s ease-out;
            box-sizing: border-box;
        }
        
        .duel-setup h1 {
            font-size: 2.5rem;
            margin-bottom: 20px;
            color: #1976d2;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 3px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .setup-options {
            display: grid;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .option-group {
            text-align: left;
        }
        
        .option-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }
        
        .option-group input, .option-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid transparent;
            border-radius: 8px;
            background: white;
            font-size: 1rem;
            color: #333;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .option-group input:focus, .option-group select:focus {
            outline: none;
            border-color: #1976d2;
            box-shadow: 0 4px 16px rgba(25, 118, 210, 0.2);
            transform: translateY(-1px);
        }
        
        .setup-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .btn {
            padding: 18px 36px;
            border: none;
            border-radius: 15px;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            text-decoration: none;
            display: inline-block;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn:hover::before {
            left: 100%;
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24, #ff6b6b);
            background-size: 200% 200%;
            color: white;
            animation: gradient-shift 3s ease infinite;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
        }
        
        .btn-primary:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 12px 30px rgba(255, 107, 107, 0.6);
            animation: none;
        }
        
        .btn-secondary {
            background: linear-gradient(45deg, #1976d2, #1565c0, #1976d2);
            background-size: 200% 200%;
            color: white;
            border: none;
            animation: gradient-shift 3s ease infinite;
            box-shadow: 0 4px 15px rgba(25, 118, 210, 0.4);
        }
        
        .btn-secondary:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 12px 30px rgba(25, 118, 210, 0.6);
            animation: none;
        }
        
        .join-section {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 1px solid #e0e0e0;
        }
        
        .join-input {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .join-input input {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
            color: #333;
        }
        
        .duel-game {
            display: none;
            background: transparent;
            padding: 30px;
            text-align: center;
            max-width: 800px;
            width: 100%;
            animation: slideIn 0.8s ease-out;
            box-sizing: border-box;
        }
        
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: transparent;
        }
        
        .player-info {
            text-align: center;
        }
        
        .player-score {
            font-size: 2.5rem;
            font-weight: bold;
            color: #1976d2;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            animation: pulse 2s ease-in-out infinite;
            position: relative;
        }
        
        .player-score::before {
            content: 'üèÜ';
            position: absolute;
            left: -30px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.5rem;
            animation: float 3s ease-in-out infinite;
        }
        
        .player-name {
            font-size: 1.1rem;
            margin-top: 5px;
            color: #666;
        }
        
        .round-info {
            text-align: center;
        }
        
        .round-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1976d2;
        }
        
        .timer {
            font-size: 4rem;
            font-weight: bold;
            color: #F44336;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            animation: countdown-pulse 1s ease-in-out infinite;
            position: relative;
        }
        
        .timer::before {
            content: '‚è∞';
            position: absolute;
            left: -60px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 2rem;
            animation: float 2s ease-in-out infinite;
        }
        
        .timer::after {
            content: '‚è∞';
            position: absolute;
            right: -60px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 2rem;
            animation: float 2s ease-in-out infinite reverse;
        }
        
        .question-display {
            font-size: 5rem;
            font-weight: bold;
            margin: 30px 0;
            color: #1976d2;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            animation: fadeInUp 0.6s ease-out;
            position: relative;
            padding: 20px;
            background: linear-gradient(135deg, rgba(25, 118, 210, 0.1), rgba(25, 118, 210, 0.05));
            border-radius: 20px;
            border: 2px solid rgba(25, 118, 210, 0.2);
        }
        
        .question-display::before {
            content: 'üßÆ';
            position: absolute;
            left: -80px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 3rem;
            animation: float 3s ease-in-out infinite;
        }
        
        .question-display::after {
            content: 'üßÆ';
            position: absolute;
            right: -80px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 3rem;
            animation: float 3s ease-in-out infinite reverse;
        }
        
        .answer-input {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
        }
        
        .answer-input input {
            font-size: 2rem;
            width: 150px;
            padding: 15px;
            border: 2px solid transparent;
            border-radius: 10px;
            background: white;
            color: #333;
            text-align: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }
        
        .answer-input input:focus {
            outline: none;
            border-color: #1976d2;
            box-shadow: 0 8px 24px rgba(25, 118, 210, 0.3);
            transform: scale(1.05);
        }
        
        .answer-input button {
            padding: 15px 30px;
            font-size: 1.2rem;
            background: linear-gradient(90deg, #F44336, #D32F2F);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .answer-input button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(244, 67, 54, 0.4);
        }
        
        .game-status {
            margin: 20px 0;
            padding: 15px;
            background: transparent;
        }
        
        .waiting-message {
            font-size: 1.2rem;
            color: #1976d2;
        }
        
        .result-display {
            display: none;
            margin: 20px 0;
            padding: 20px;
            background: transparent;
        }
        
        .result-correct {
            background: rgba(0, 184, 148, 0.3);
            border: 2px solid #00b894;
        }
        
        .result-incorrect {
            background: rgba(255, 107, 107, 0.3);
            border: 2px solid #ff6b6b;
        }
        
        .final-results {
            display: none;
            text-align: center;
        }
        
        .winner-announcement {
            font-size: 2.5rem;
            font-weight: bold;
            color: #1976d2;
            margin: 20px 0;
        }
        
        .final-scores {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 30px 0;
        }
        
        .final-score-card {
            background: transparent;
            padding: 20px;
            border: 1px solid #e0e0e0;
        }
        
        .final-score-value {
            font-size: 2rem;
            font-weight: bold;
            color: #1976d2;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2rem;
            color: #1976d2;
        }
        
        .error-message {
            background: rgba(244, 67, 54, 0.1);
            border: 1px solid #F44336;
            color: #d32f2f;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }
        
        @media (max-width: 768px) {
            .duel-setup, .duel-game {
                padding: 20px;
                margin: 10px;
            }
            
            .setup-buttons {
                grid-template-columns: 1fr;
            }
            
            .game-header {
                flex-direction: column;
                gap: 20px;
            }
            
            .question-display {
                font-size: 2.5rem;
            }
            
            .answer-input {
                flex-direction: column;
                align-items: center;
            }
            
            .final-scores {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>


    <div class="top-bar">
        <a href="/" style="text-decoration:none;color:inherit;display:flex;align-items:center;">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="none" viewBox="0 0 24 24"><path fill="#1976d2" d="M3 11.5V21h6v-5h6v5h6v-9.5l-9-7-9 7Z"/></svg>
        </a>
        <div></div>
        <div>Duel Mode</div>
    </div>

    <div class="main-container">
        <!-- Duel Setup Section -->
        <div class="duel-setup" id="duelSetup">
            <h1>Math Duel</h1>
            <p style="margin-bottom: 30px; color: #666;">Challenge a friend to a real-time math battle!</p>
            
            <div class="setup-options">
                <div class="option-group">
                    <label for="timeLimit">Time per question (seconds):</label>
                    <select id="timeLimit">
                        <option value="15">15 seconds</option>
                        <option value="20">20 seconds</option>
                        <option value="30" selected>30 seconds</option>
                        <option value="45">45 seconds</option>
                        <option value="60">60 seconds</option>
                    </select>
                </div>
                
                <div class="option-group">
                    <label for="maxRounds">Number of rounds:</label>
                    <select id="maxRounds">
                        <option value="5">5 rounds</option>
                        <option value="10" selected>10 rounds</option>
                        <option value="15">15 rounds</option>
                        <option value="20">20 rounds</option>
                    </select>
                </div>
            </div>
            
            <div class="setup-buttons">
                <button class="btn btn-primary" onclick="createDuel()">Create Duel</button>
                <button class="btn btn-secondary" onclick="showJoinSection()">Join Duel</button>
            </div>
            
            <div class="join-section" id="joinSection" style="display: none;">
                <h3>Join Existing Duel</h3>
                <div class="join-input">
                    <input type="text" id="roomCode" placeholder="Enter room code">
                    <button class="btn btn-primary" onclick="joinDuel()">Join</button>
                </div>
                <button class="btn btn-secondary" onclick="hideJoinSection()">Cancel</button>
            </div>
        </div>

        <!-- Duel Game Section -->
        <div class="duel-game" id="duelGame">
            <div class="game-header">
                <div class="player-info">
                    <div class="player-score" id="player1Score">0</div>
                    <div class="player-name" id="player1Name">You</div>
                </div>
                
                <div class="round-info">
                    <div class="round-number" id="roundDisplay">Round 1</div>
                    <div id="gameStatus">Waiting for opponent...</div>
                </div>
                
                <div class="player-info">
                    <div class="player-score" id="player2Score">0</div>
                    <div class="player-name" id="player2Name">Opponent</div>
                </div>
            </div>
            
            <div class="timer" id="timer">30</div>
            <div class="question-display" id="questionDisplay">Waiting...</div>
            
            <div class="answer-input">
                <input type="number" id="answerInput" placeholder="?" autocomplete="off">
                <button onclick="submitAnswer()">Submit</button>
            </div>
            
            <div class="game-status" id="gameStatusDisplay">
                <div class="waiting-message">Waiting for opponent to join...</div>
            </div>
            
            <div class="result-display" id="resultDisplay"></div>
            
            <div class="final-results" id="finalResults">
                <div class="winner-announcement" id="winnerAnnouncement"></div>
                <div class="final-scores" id="finalScores"></div>
                <button class="btn btn-primary" onclick="returnToMenu()">Back to Menu</button>
            </div>
        </div>
    </div>

    <script>
        let socket;
        let currentRoom = null;
        let currentUser = null;
        let gameTimer = null;
        let timeRemaining = 30;
        let questionStartTime = null;
        let isMyTurn = false;
        let hasAnswered = false;

        // Initialize WebSocket connection
        function initializeSocket() {
            socket = io();
            
            socket.on('connect', function() {
                console.log('Connected to server');
            });
            
            socket.on('connected', function(data) {
                console.log('Server confirmed connection:', data.message);
            });
            
            socket.on('player_joined', function(data) {
                console.log('Player joined:', data.message);
                updateGameStatus('Opponent joined! Starting duel...');
                
                // Start the duel after a short delay
                setTimeout(() => {
                    socket.emit('start_duel', { room_id: currentRoom });
                }, 2000);
            });
            
            socket.on('round_started', function(data) {
                console.log('Round started:', data);
                startNewRound(data);
            });
            
            socket.on('answer_result', function(data) {
                console.log('Answer result:', data);
                showAnswerResult(data);
            });
            
            socket.on('opponent_answered', function(data) {
                console.log('Opponent answered:', data);
                updateGameStatus(`Opponent answered ${data.correct ? 'correctly' : 'incorrectly'}! +${data.points} points`);
            });
            
            socket.on('duel_ended', function(data) {
                console.log('Duel ended:', data);
                showFinalResults(data);
            });
            
            socket.on('player_left', function(data) {
                console.log('Player left:', data.message);
                updateGameStatus('Opponent left the duel');
            });
        }

        // Create a new duel
        async function createDuel() {
            const timeLimit = parseInt(document.getElementById('timeLimit').value);
            const maxRounds = parseInt(document.getElementById('maxRounds').value);
            
            try {
                const response = await fetch('/api/duel/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        time_limit: timeLimit,
                        max_rounds: maxRounds
                    }),
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    currentRoom = data.room_id;
                    timeRemaining = timeLimit;
                    
                    // Join the WebSocket room
                    socket.emit('join_duel_room', {
                        room_id: currentRoom,
                        user_id: getCurrentUserId()
                    });
                    
                    // Show game interface
                    document.getElementById('duelSetup').style.display = 'none';
                    document.getElementById('duelGame').style.display = 'block';
                    
                    updateGameStatus('Waiting for opponent to join... Share this room code: ' + currentRoom);
                } else {
                    showError(data.error);
                }
            } catch (error) {
                showError('Failed to create duel: ' + error.message);
            }
        }

        // Join an existing duel
        async function joinDuel() {
            const roomCode = document.getElementById('roomCode').value.trim();
            
            if (!roomCode) {
                showError('Please enter a room code');
                return;
            }
            
            try {
                const response = await fetch(`/api/duel/join/${roomCode}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    currentRoom = roomCode;
                    
                    // Join the WebSocket room
                    socket.emit('join_duel_room', {
                        room_id: currentRoom,
                        user_id: getCurrentUserId()
                    });
                    
                    // Show game interface
                    document.getElementById('duelSetup').style.display = 'none';
                    document.getElementById('duelGame').style.display = 'block';
                    
                    updateGameStatus('Joined duel! Waiting for host to start...');
                } else {
                    showError(data.error);
                }
            } catch (error) {
                showError('Failed to join duel: ' + error.message);
            }
        }

        // Start a new round
        function startNewRound(roundData) {
            document.getElementById('questionDisplay').textContent = roundData.question;
            document.getElementById('roundDisplay').textContent = `Round ${roundData.round}`;
            
            timeRemaining = roundData.time_limit;
            questionStartTime = Date.now();
            hasAnswered = false;
            isMyTurn = true;
            
            // Reset UI
            document.getElementById('answerInput').value = '';
            document.getElementById('answerInput').disabled = false;
            document.getElementById('resultDisplay').style.display = 'none';
            document.getElementById('gameStatusDisplay').style.display = 'block';
            
            // Start timer
            startTimer();
            
            updateGameStatus('Answer the question!');
        }

        // Start the countdown timer
        function startTimer() {
            if (gameTimer) clearInterval(gameTimer);
            
            gameTimer = setInterval(() => {
                timeRemaining--;
                document.getElementById('timer').textContent = timeRemaining;
                
                if (timeRemaining <= 0) {
                    clearInterval(gameTimer);
                    if (!hasAnswered) {
                        submitAnswer(); // Auto-submit when time runs out
                    }
                }
                
                // Change color based on time remaining
                if (timeRemaining <= 5) {
                    document.getElementById('timer').style.color = '#ff6b6b';
                } else if (timeRemaining <= 10) {
                    document.getElementById('timer').style.color = '#ffa726';
                }
            }, 1000);
        }

        // Submit answer
        function submitAnswer() {
            if (hasAnswered || !isMyTurn) return;
            
            const answer = parseInt(document.getElementById('answerInput').value);
            if (isNaN(answer)) {
                showError('Please enter a valid number');
                return;
            }
            
            const responseTime = (Date.now() - questionStartTime) / 1000;
            
            // Disable input and submit
            document.getElementById('answerInput').disabled = true;
            hasAnswered = true;
            isMyTurn = false;
            
            // Send answer to server
            socket.emit('submit_answer', {
                room_id: currentRoom,
                user_id: getCurrentUserId(),
                answer: answer,
                response_time: responseTime
            });
            
            updateGameStatus('Answer submitted! Waiting for opponent...');
        }

        // Show answer result
        function showAnswerResult(result) {
            const resultDisplay = document.getElementById('resultDisplay');
            resultDisplay.style.display = 'block';
            
            if (result.correct) {
                resultDisplay.className = 'result-display result-correct';
                resultDisplay.innerHTML = `
                    <h3>‚úÖ Correct!</h3>
                    <p>+${result.points} points</p>
                    <p>Response time: ${result.response_time.toFixed(1)}s</p>
                `;
            } else {
                resultDisplay.className = 'result-display result-incorrect';
                resultDisplay.innerHTML = `
                    <h3>‚ùå Incorrect</h3>
                    <p>The answer was: ${result.current_answer}</p>
                    <p>Response time: ${result.response_time.toFixed(1)}s</p>
                `;
            }
            
            // Update score
            updateScore(result.total_score);
        }

        // Show final results
        function showFinalResults(data) {
            clearInterval(gameTimer);
            
            const winnerAnnouncement = document.getElementById('winnerAnnouncement');
            const finalScores = document.getElementById('finalScores');
            
            if (data.winner == getCurrentUserId()) {
                winnerAnnouncement.textContent = 'üèÜ You Won! üèÜ';
            } else {
                winnerAnnouncement.textContent = 'üòî You Lost üòî';
            }
            
            // Display final scores
            finalScores.innerHTML = '';
            for (const [userId, score] of Object.entries(data.final_scores)) {
                const isCurrentUser = userId == getCurrentUserId();
                const playerName = isCurrentUser ? 'You' : 'Opponent';
                
                finalScores.innerHTML += `
                    <div class="final-score-card">
                        <div class="final-score-value">${score}</div>
                        <div class="player-name">${playerName}</div>
                    </div>
                `;
            }
            
            document.getElementById('gameStatusDisplay').style.display = 'none';
            document.getElementById('resultDisplay').style.display = 'none';
            document.getElementById('finalResults').style.display = 'block';
        }

        // Update score display
        function updateScore(score) {
            document.getElementById('player1Score').textContent = score;
        }

        // Update game status
        function updateGameStatus(message) {
            document.getElementById('gameStatus').textContent = message;
            document.getElementById('gameStatusDisplay').innerHTML = `
                <div class="waiting-message">${message}</div>
            `;
        }

        // Show/hide join section
        function showJoinSection() {
            document.getElementById('joinSection').style.display = 'block';
        }
        
        function hideJoinSection() {
            document.getElementById('joinSection').style.display = 'none';
        }

        // Show error message
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            
            document.querySelector('.main-container').appendChild(errorDiv);
            
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }

        // Return to main menu
        function returnToMenu() {
            window.location.href = '/';
        }

        // Get current user ID (you'll need to implement this based on your auth system)
        function getCurrentUserId() {
            // This should return the current user's ID from your session/auth system
            // For now, we'll use a placeholder
            return 'user_' + Math.random().toString(36).substr(2, 9);
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeSocket();
        });
    </script>
</body>
</html>
